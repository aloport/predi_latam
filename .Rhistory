fcb <- cache_filesystem("/tmp/cache")  # Obviouslly you don't wont persistent cache in tmp
f <- function(x) x
g <- memoise(f, cache = fc)
dir("/tmp/cache")
g(1)
##Create a cache
fc <- cache_filesystem("~/Dropbox (Tu equipo)/PhD thesis/General/Paper 1/.cache")
#Translate!
gl_translate_ <- memoise(gl_translate, cache = fc)
gl_translate_delay <- function(source, target, delay) {
f <- function (text) {
Sys.sleep(delay)
if(is.na(text)) {
NA_character_
} else {
gl_translate_(text, source = source, target = target)$translatedText
}
}
function(texts) map_chr(texts, f)
}
gl_translate_delay_3_sv_en <- gl_translate_delay("sv", "en", 0.5)
sweden_notr_final <- sweden_notr %>% mutate_at(.vars = vars(c(3, 10:25)),
.funs = funs(gl_translate_delay_3_sv_en))
sweden_notr_final <- sweden_notr %>% mutate_at(.vars = vars(c(3, 10:25)),
.funs = funs(gl_translate_delay_3_sv_en))
sweden_notr_final <- sweden_notr %>% mutate_at(.vars = vars(c(3, 10:25)),
.funs = funs(gl_translate_delay_3_sv_en))
install_github("ajparsons/everypoliticianR")
##Partido
library(devtools)
install_github("ajparsons/everypoliticianR")
Sys.getlocale()
```Sys.setlocale(category = "LC_ALL", locale = "en_US.UTF-8")```
Sys.setlocale(category = "LC_ALL", locale = "en_US.UTF-8")
##Partido
library(devtools)
install_github("ajparsons/everypoliticianR")
quit
quit()
load("/Users/ortega/Downloads/1d_model_stan.Rda")
install.packages('devtools')
devtools::install_github('rwhatsapp')
devtools::install_github('JBGruber/rwhatsapp')
devtools::install_github('JBGruber/rwhatsapp')
# installing/loading the package:
if(!require(installr)) {
install.packages("installr");
require(installr)
} #load / install+load installr
# using the package:
updateR()
Sys.getenv()
$LC_CTYPE
Sys.setlocale()
Sys.getlocale("LC_TIME")
if(all((localeToCharset()[1] == c("UTF-8", "CP949", "EUC-KR")) == FALSE)){
packageStartupMessage("This R shell doesn't contain any Hangul encoding.\nFor fully use, any of 'UTF-8', 'CP949', 'EUC-KR' needs to be used for R shell encoding.")
}
Sys.setlocale()
Sys.setlocale(locale="English_United States")
[1] "LC_COLLATE=English_United States.1252;LC_CTYPE=English_United States.1252;LC_MONETARY=English_United States.1252;LC_NUMERIC=C;LC_TIME=English_United States.1252"
Sys.setlocale(locale="English_United States")
"LC_COLLATE=English_United States.1252;LC_CTYPE=English_United States.1252;LC_MONETARY=English_United States.1252;LC_NUMERIC=C;LC_TIME=English_United States.1252"
Sys.setlocale(locale="English_United States")
source('utf-8-file.r', encoding='UTF-8')
Systemgebietsschema: de-ch;Deutsch (Schweiz)
Systemgebietsschema:
)
Systemgebietsschema
Sys.setlocale(locale="English_Switzerland")
Sys.setlocale(locale="English_United Kingdom")
Sys.setenv(LANG="en_US.UTF-8")
Sys.setenv(LC_ALL="en_US.UTF-8")
Sys.setenv(LC_ALL="en_US.UTF-8")
Sys.getenv("LANG")
Sys.getenv()
system("defaults write org.R-project.R force.LANG en_US.UTF-8")
Sys.getenv()
Sys.setlocale(LC_COLLATE ="en_US.UTF-8")
Sys.setenv(LC_COLLATE ="en_US.UTF-8")
Sys.getenv()
Sys.setenv(LC_MONETARY ="en_US.UTF-8")
Sys.setenv(LC_NUMERIC ="en_US.UTF-8")
Sys.setenv(LC_TIME ="en_US.UTF-8")
Sys.setenv(LC_CTYPE  ="en_US.UTF-8")
Sys.getenv()
devtools::install_github("ropenscilabs/icon")
system("defaults write org.R-project.R force.LANG force.CTYPE en_US.UTF-8")
system("defaults write org.R-project.R force.CTYPE en_US.UTF-8")
> system("defaults write org.R-project.R force.COLLATE en_US.UTF-8")
system("defaults write org.R-project.R force.COLLATE en_US.UTF-8")
system("defaults write org.R-project.R force.MONETARY en_US.UTF-8")
system("defaults write org.R-project.R force.TIME en_US.UTF-8")
Sys.getenv()
Sys.getenv()
Sys.getenv()
Sys.getenv()
system("defaults write org.R-project.R force.LC_COLLATE en_US.UTF-8")
Sys.getenv()
system("defaults write org.R-project.R force.COLLATE en_US.UTF-8")
Sys.getenv()
Sys.setenv(LC_COLLATE = "en_US.UTF-8")
Sys.getenv()
Sys.setenv(LC_COLLATE = "en_US.UTF-8")
Sys.setenv(LC_CTYPE  = "en_US.UTF-8")
Sys.setenv(LC_MONETARY = "en_US.UTF-8")
Sys.setenv(LC_NUMERIC = "en_US.UTF-8")
Sys.setenv(LC_TIME = "en_US.UTF-8")
predi28A26M <- read.csv("/Users/ortega/Alberto/Alberto López Ortega/Side projects/S1 - Predi w Strijbis/Prediction markets/26M/code/pricehistory-2019.05.21-16.52.csv", fileEncoding = "UTF-8")
library(tidyverse)
library(lubridate)
library(ggplot2)
library(zoo)
library(DT)
library(highcharter)
library(ggrepel)
library(directlabels)
library(ggthemes)
library(gganimate)
predi28A26M <- read.csv("/Users/ortega/Alberto/Alberto López Ortega/Side projects/S1 - Predi w Strijbis/Prediction markets/26M/code/pricehistory-2019.05.21-16.52.csv", fileEncoding = "UTF-8")
predi28A26M <- read.csv("/Users/ortega/Alberto/Alberto López Ortega/Side projects/S1 - Predi w Strijbis/Prediction markets/26M/code/pricehistory-2019.05.21-16.52.csv", fileEncoding = "UTF-8")
load("/Users/ortega/Alberto/Alberto López Ortega/Side projects/S1 - Predi w Strijbis/Prediction markets/28A y 26M/intrapolation_all.RData")
load("/Users/ortega/Alberto/Alberto López Ortega/Side projects/S1 - Predi w Strijbis/Prediction markets/28A y 26M/intrapolation_inner.RData")
predi28A26M <- predi28A26M %>%
separate(prices, c('contract1', 'contract2', 'contract3', 'contract4', 'contract5', 'contract6', 'contract7'), sep = ',') %>%
separate(time, c('weekday', 'monthday', 'yeartime'), sep= ',') %>%
mutate(datetime= mdy_hm(paste(monthday, yeartime, sep = ' '))) %>%
mutate_at(vars(contract1:contract7), funs(str_sub(., 20))) %>%
#remove the IDs from each contract
mutate_at(vars(contract1:contract7), funs(as.numeric)) %>%
mutate(market_id = ifelse(str_detect(market_id, "zSk5eS8p6PGZZ2MMa"), "28a_26", "other")) %>%
#change name of the market
mutate(set_id = ifelse(str_detect(set_id,  "C527E27e4v3oih4Yw"), "comision",
ifelse(str_detect(set_id,  "jGWXeuYvj92bQ78ev"), "cmadrid",
ifelse(str_detect(set_id, "aBNaTgnSxQEaXwAeC"), "aragon",
ifelse(str_detect(set_id, "ryirGudjDyK3FnBGT"), "extremadura",
ifelse(str_detect(set_id, "8YcCXd28NdTyupxoH"), "baleares",
ifelse(str_detect(set_id, "mhSCHid5juQJQfAzZ"), "madrid",
ifelse(str_detect(set_id, "WfRT5gpCkj6ncKjnF"), "barcelona",
ifelse(str_detect(set_id, "5LR8WtEjLEcnqqPY5"), "cvalenciana",
ifelse(str_detect(set_id, "8MHt5GHbaGeHq3dwS"), "cmadrid_a",
ifelse(str_detect(set_id, "giXvSY9EdDcsYCgPF"), "madrid_a",
ifelse(str_detect(set_id, "LB7ab8sQ4p4uQQgWJ"), "valencia_a",
ifelse(str_detect(set_id, "q5N6ykCAwDQkb6qHv"), "barcelona_a",
ifelse(str_detect(set_id, "wD6TZthrHCvBsA724"), "espana",
ifelse(str_detect(set_id, "NSCcQ9qaKYTZtiniC"), "valencia", "other"))))))))))))))) %>%
filter(market_id== "28a_26" & set_id!= "other") %>%
#select only 28a_26m market > only 28A contractsets
select(datetime, set_id, c(contract1:contract7))
comision_set <-  predi28A26M %>%
filter(set_id== "comision") %>%
select(datetime, `Manfred Weber (EPP)`= contract1, `Frans Timmermans (PES)`= contract2, `Jan Zahradil (ECR)`= contract3, `Viola Tomic (GUE)`= contract4, `Guy Verhofstadt (ALDE)`= contract5, `Otro/a`= contract6)
comision_gather  <- comision_set %>%
mutate(datetime = round_date(datetime, unit="24 hours")) %>%
group_by(datetime) %>%
mutate_all(list(mean)) %>%
distinct()  %>%
mutate_if(is.numeric, round, 2) %>%
gather("type", "prob", c(`Manfred Weber (EPP)`:`Otro/a`))
gobierno_eu_19 <- comision_set %>%
mutate_at(vars(2:7), ~(.*96)/100) %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
sub_set <-  predi28A26M %>%
filter(set_id!= "comision" & set_id!="barcelona" & set_id!= "cmadrid_a" & set_id!="madrid_a" & set_id!= "barcelona_a" & set_id!="valencia_a") %>%
select(datetime, set_id, coalition_left= contract1, coalition_center= contract2, coalition_right= contract3,
singlecolor_left= contract4, singlecolor_center= contract5, singlecolor_right= contract6) %>%
mutate(datetime = round_date(datetime, unit="24 hours")) %>%
group_by(datetime, set_id) %>%
mutate_if(is.numeric,list(mean)) %>%
distinct()  %>%
mutate_if(is.numeric, round, 2) %>%
rowwise() %>%
mutate(sum = 100- sum(coalition_left, coalition_center, coalition_right, singlecolor_center, singlecolor_right, singlecolor_left))
sub_gather <- sub_set %>%
ungroup(datetime) %>%
select(set_id, datetime, `Gobierno de coalición de izquierdas`= "coalition_left", `Gobierno de coalición de centro`="coalition_center", `Gobierno de coalición de derechas`="coalition_right", `Gobierno monocolor de izquierdas`="singlecolor_left", `Gobierno monocolor de centro`="singlecolor_center", `Gobierno monocolor de derechas`="singlecolor_right", `Repetición electoral`="sum") %>%
gather("type", "prob", c(`Gobierno de coalición de izquierdas`:`Repetición electoral`)) %>%
mutate(coloract = ifelse(str_detect(type, "Gobierno de coalición de izquierdas"), "#9A0000",
ifelse(str_detect(type,  "Gobierno de coalición de centro"), "#C57420",
ifelse(str_detect(type,  "Gobierno de coalición de derechas"), "#0000BA",
ifelse(str_detect(type,  "Gobierno monocolor de izquierdas"), "#FF3827",
ifelse(str_detect(type,  "Gobierno monocolor de centro"), "#FF9300",
ifelse(str_detect(type,  "Gobierno monocolor de derechas"), "#04AAFF",
ifelse(str_detect(type,  "Repetición electoral"), "#babdbe",
"other"))))))))
sub_little <- sub_gather %>%
group_by(set_id, type) %>%
filter(datetime == max(datetime)) %>%
mutate_if(is.numeric, round, 2) %>%
select(coloract, datetime, set_id, type, prob) %>%
arrange(desc(prob))
gobierno_cma_19 <- sub_set %>%
filter(set_id=="cmadrid") %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
gobierno_ara_19 <- sub_set %>%
filter(set_id=="aragon") %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
gobierno_bal_19 <- sub_set %>%
filter(set_id=="baleares") %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
gobierno_ext_19 <- sub_set %>%
filter(set_id=="extremadura") %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
gobierno_cva_19 <- sub_set %>%
filter(set_id=="cvalenciana") %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
gobierno_mad_19 <- sub_set %>%
filter(set_id=="madrid") %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
gobierno_val_19 <- sub_set %>%
filter(set_id=="valencia") %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
gobierno_esp_19 <- sub_set %>%
filter(set_id=="espana") %>%
mutate_at(vars(3:8), ~(.*96)/100) %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
#/ barcelona
bar_set <-  predi28A26M %>%
filter(set_id=="barcelona") %>%
mutate(datetime = round_date(datetime, unit="24 hours")) %>%
group_by(datetime) %>%
select(datetime, set_id, coalition_left= contract1, coalition_trans= contract2, coalition_indy= contract3,
singlecolor_left= contract4, singlecolor_trans= contract5, singlecolor_indy= contract6) %>%
mutate_if(is.numeric,list(mean)) %>%
distinct()  %>%
mutate_if(is.numeric, round, 2) %>%
rowwise() %>%
mutate(sum = 100- sum(coalition_left, coalition_trans, coalition_indy, singlecolor_trans, singlecolor_indy, singlecolor_left))
bar_gather <-bar_set %>%
ungroup(datetime) %>%
select(set_id, datetime, `Gobierno de coalición de izquierdas`= "coalition_left", `Gobierno de coalición mixto*`="coalition_trans", `Gobierno de coalición de soberanistas`="coalition_indy", `Gobierno monocolor de izquierdas`="singlecolor_left", `Gobierno monocolor mixto*`="singlecolor_trans", `Gobierno monocolor de soberanistas`="singlecolor_indy", `Repetición electoral`="sum") %>%
gather("type", "prob", c(`Gobierno de coalición de izquierdas`:`Repetición electoral`)) %>%
mutate(coloract = ifelse(str_detect(type, "Gobierno de coalición de izquierdas"), "#9A0000",
ifelse(str_detect(type,  "Gobierno de coalición mixto*"), "#bf5f82",
ifelse(str_detect(type,  "Gobierno de coalición de soberanistas"), "#c79a00",
ifelse(str_detect(type,  "Gobierno monocolor de izquierdas"), "#FF3827",
ifelse(str_detect(type,  "Gobierno monocolor mixto*"), "#f48fb1",
ifelse(str_detect(type,  "Gobierno monocolor de soberanistas"), "#ffca28",
ifelse(str_detect(type,  "Repetición electoral"), "#babdbe",
"other"))))))))
gobierno_bar_19 <- bar_set %>%
mutate_at(vars(3:8), ~(.*96)/100) %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
##general elections
#####VOTO
intrapolation_reduce <- intrapolation_inner %>%
filter(probability=="50") %>%
select(-probability) %>%
ungroup() %>%
add_row(datetime= "2019-04-19",
up= 14.29,
vox= 12.83,
cs= 16.04,
pp= 21.13,
psoe= 29.59) %>%
mutate_at(vars(2:6), ~(.*96)/100) %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
intrapolation_little <- intrapolation_inner %>%
ungroup(datetime) %>%
filter(probability=="50") %>%
ungroup() %>%
add_row(datetime= "2019-04-19",
up= 14.29,
vox= 12.83,
cs= 16.04,
pp= 21.13,
psoe= 29.59) %>%
mutate_at(vars(3:7), ~(.*96)/100) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2) %>%
select(datetime2, `Unidas Podemos`= "up", VOX="vox", Ciudadanos="cs", PP="pp", PSOE="psoe") %>%
gather("party", "vote", c(`Unidas Podemos`:'PSOE')) %>%
group_by(party) %>%
mutate(diff = vote - lag(vote, default = first(vote))) %>%
filter(datetime2 == max(datetime2)) %>%
mutate_if(is.numeric, round, 2) %>%
select(party, vote, diff) %>%
arrange(desc(vote))
intrapolation_gather <- intrapolation_reduce %>%
select(datetime, UP= "up", VOX="vox", Cs="cs", PP="pp", PSOE="psoe") %>%
gather("party", "vote", c('UP':'PSOE'))
first_mad_set <-  predi28A26M %>%
filter(set_id== "madrid_a") %>%
rowwise() %>%
mutate("Other"= sum(contract5, contract6)) %>%
select(datetime, set_id, PSOE=contract1, PP=contract2, Ciudadanos=contract3, `Más Madrid`=contract4, Other) %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
first_cma_set <-  predi28A26M %>%
filter(set_id== "cmadrid_a") %>%
select(datetime, set_id, PSOE=contract1, PP=contract2, Ciudadanos=contract3, `Más Madrid`=contract4, Other=contract5)%>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
first_val_set <-  predi28A26M %>%
filter(set_id== "valencia_a") %>%
rowwise() %>%
mutate("Other"= sum(contract5, contract6)) %>%
select(datetime, set_id, PSOE=contract1, PP=contract2, Compromís=contract3, `Ciutadans`=contract4, Other)%>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
first_bar_set <-  predi28A26M %>%
filter(set_id== "barcelona_a") %>%
rowwise() %>%
mutate("Other"= sum(contract5, contract6)) %>%
select(datetime, set_id, ERC=contract1, BComú=contract2, PSC=contract3, Valls=contract4, Other)%>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
first_set <- first_mad_set %>%
bind_rows(first_cma_set, first_val_set, first_bar_set) %>%
mutate(datetime = round_date(datetime, unit="24 hours")) %>%
group_by(datetime, set_id) %>%
mutate_if(is.numeric,list(mean)) %>%
distinct()  %>%
mutate_if(is.numeric, round, 2) %>%
select(datetime, datetime2, everything())
#######ejemplo
`Contratos de voto al PP` <- c("Contrato A", "Contrato B", "Contrato C", "Contrato D", "Contrato E")
`Margen de estimación de voto al PP` <- c("17% votos o menos", "17%-19'99% votos", "20%-22'99% votos", "23%-25'99% votos", "26% votos o más")
`Probabilidad de cada contrato (ejemplo)` <- c("10%", "20%", "40%", "20%", "10%")
Ejemplo <- as.data.frame(cbind(`Contratos de voto al PP`, `Margen de estimación de voto al PP`, `Probabilidad de cada contrato (ejemplo)`))
`Estimación de voto al PP` <- c("100% de votos", "> 26% de votos", "> 23% de votos", "21% de votos", "> 20% de votos", "> 17% de votos", "> 0% de votos")
`Probabilidad acumulada` <- c("0%", "10%", "30%", "50%", "70%", "90%", "100%")
`Agregación` <- c("Ninguno",
"Contrato E",
"Contrato D + Contrato E",
"Resultado de la interpolación",
"Contrato C + Contrato D + Contrato E",
"Contrato B + Contrato C +  Contrato D + Contrato E",
"Contrato A + Contrato B + Contrato C + Contrato D + Contrato E")
Ejemplo_2 <- as.data.frame(cbind(`Estimación de voto al PP`, `Probabilidad acumulada`, `Agregación`))
x <- c(100, 26, 23, NA, 20, 17, 0)
y <- c(0, 10, 30, 50, 70, 90, 100)
Ejemplo_3 <- as.data.frame(cbind(x, y))
Ejemplo_3$vote_ = coalesce(as.numeric(x), na.approx(x, y))
index <- sub_gather %>%
bind_rows(bar_gather) %>%
spread(set_id, prob) %>%
select(datetime, type, coloract, España= "espana", `C. Valenciana`= "cvalenciana", `C. Madrid`="cmadrid", Madrid="madrid", Barcelona="barcelona", Valencia="valencia")
index_graph <- index %>%
gather("set_id", "prob", c(España:Valencia)) %>%
group_by(set_id, type) %>%
drop_na() %>%
filter(datetime == max(datetime)) %>%
mutate_if(is.numeric, round, 2) %>%
select(coloract, datetime, set_id, type, prob)
coalimono <- sub_set %>%
bind_rows(bar_set) %>%
mutate(datetime = as.Date(datetime)) %>%
complete(datetime = seq.Date(min(datetime), max(datetime), by="day")) %>%
rowwise() %>%
mutate(`Gob. coalición`= sum(coalition_center, coalition_left, coalition_right, coalition_trans, coalition_indy, na.rm=TRUE),
`Gob. monocolor`= sum(singlecolor_left, singlecolor_center, singlecolor_right, singlecolor_trans, singlecolor_indy, na.rm=TRUE)) %>%
select(`Gob. coalición`, `Gob. monocolor`, datetime, set_id)%>%
gather("type", "prob", c(`Gob. coalición`:`Gob. monocolor`)) %>%
spread(set_id, prob) %>%
select(datetime, type,`C. Madrid`="cmadrid", `España`= "espana", `C. Valenciana`="cvalenciana", Madrid="madrid", Valencia="valencia", Barcelona="barcelona") %>%
gather("set_id", "prob", c(`C. Madrid`:`Barcelona`)) %>%
group_by(type, set_id) %>%
fill(prob) %>%
ungroup() %>%
mutate(set = paste0("Tipo de gobierno"))
rightleft <- sub_set %>%
bind_rows(bar_set) %>%
mutate(datetime = as.Date(datetime)) %>%
complete(datetime = seq.Date(min(datetime), max(datetime), by="day")) %>%
group_by(set_id, datetime) %>%
mutate(`G. derecha`= sum(coalition_right, singlecolor_right),
`G. izquierda`= sum(singlecolor_left, coalition_left),
`G. centro`= sum(singlecolor_center, coalition_center),
`G. mixto`= sum(singlecolor_trans, coalition_trans),
`G. secesionista`= sum(singlecolor_indy, coalition_indy),
) %>%
select(`G. derecha`, `G. izquierda`, `G. centro`, `G. mixto`, `G. secesionista`, datetime, set_id)%>%
gather("type", "prob", c(`G. derecha`:`G. secesionista`)) %>%
spread(set_id, prob) %>%
select(datetime, type,`C. Madrid`="cmadrid", `España`= "espana", `C. Valenciana`="cvalenciana", Madrid="madrid", Valencia="valencia", Barcelona="barcelona") %>%
gather("set_id", "prob", c(`C. Madrid`:`Barcelona`)) %>%
group_by(type, set_id) %>%
fill(prob) %>%
ungroup() %>%
mutate(set = paste0("Orientación del gobierno"))
###PRESIS
who_leads <- first_set %>%
ungroup() %>%
mutate(datetime = as.Date(datetime)) %>%
complete(datetime = seq.Date(min(datetime), max(datetime), by="day")) %>%
gather("type", "prob", c(PSOE:Valls)) %>%
mutate(set_id = ifelse(str_detect(set_id, "espana_a"), "España",
ifelse(str_detect(set_id,  "cvalenciana_a"), "C. Valenciana",
ifelse(str_detect(set_id,  "valencia_a"), "Valencia",
ifelse(str_detect(set_id,  "barcelona_a"), "Barcelona",
ifelse(str_detect(set_id,  "cmadrid_a"), "C. Madrid",
ifelse(str_detect(set_id,  "madrid_a"), "Madrid", "other"
))))))) %>%
group_by(type, set_id) %>%
fill(prob)
who_leads_index <-  who_leads %>%
group_by(set_id, type) %>%
drop_na() %>%
filter(datetime == max(datetime)) %>%
arrange(desc(prob)) %>%
mutate_if(is.numeric, round, 2) %>%
select(datetime, set_id, type, prob) %>%
mutate(coloract = ifelse(str_detect(type, "PSOE"), "#FF3827",
ifelse(str_detect(type,  "PSC"), "#FF3827",
ifelse(str_detect(type,  "PP"), "#04AAFF",
ifelse(str_detect(type,  "Ciudadanos"), "#FF9300",
ifelse(str_detect(type,  "Ciutadans"), "#FF9300",
ifelse(str_detect(type,  "ERC"), "#fdd835",
ifelse(str_detect(type,  "Valls"), "#FF9300",
ifelse(str_detect(type,  "BComú"), "#8e0000",
ifelse(str_detect(type,  "Más Madrid"), "#00766c",
ifelse(str_detect(type,  "Compromís"), "#8d6e63",
ifelse(str_detect(type,  "Other"), "#8d8d8d",
"other")))))))))))) %>%
distinct()
who_leads_gif <- who_leads %>%
filter(type!="Other") %>%
ungroup() %>%
mutate(set = paste0("Primer partido"))
all_together <- full_join(coalimono, rightleft) %>%
full_join(., who_leads_gif)
all_together$electiondate <- "2019-05-26"
all_together$daytoelect <- as.Date(all_together$electiondate, "%Y-%m-%d")- as.Date(all_together$datetime, "%Y-%m-%d")
all_together$daytoelect <- -1*all_together$daytoelect
espana_gif <- all_together %>%
filter(set_id== "España")
cmadrid_gif <- all_together %>%
filter(set_id== "C. Madrid")
madrid_gif <- all_together %>%
filter(set_id== "Madrid")
valencia_gif <- all_together %>%
filter(set_id== "Valencia")
cvalenciana_gif <- all_together %>%
filter(set_id== "C. Valenciana")
barcelona_gif <- all_together %>%
filter(set_id== "Barcelona")
####generales old
generales_set <-  predi28A26M %>%
filter(set_id== "generales_set") %>%
select(datetime, coalition_left= contract1, coalition_center= contract2, coalition_right= contract3,
singlecolor_left= contract4, singlecolor_center= contract5, singlecolor_right= contract6, rep_elections= contract7)
generales_reduce <- generales_set %>%
mutate(datetime = round_date(datetime, unit="24 hours")) %>%
group_by(datetime) %>%
mutate_all(list(mean=mean)) %>%
select(-c(2:8)) %>%
distinct() %>%
select(coalition_left= coalition_left_mean,
coalition_center=coalition_center_mean,
coalition_right=coalition_right_mean,
singlecolor_left=singlecolor_left_mean,
singlecolor_center=singlecolor_center_mean,
singlecolor_right=singlecolor_right_mean,
repetition_elections=rep_elections_mean) %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
filter(datetime<"2019-05-05")
generales_little <- generales_reduce %>%
ungroup(datetime) %>%
select(datetime, `Gobierno de coalición de izquierdas`= "coalition_left", `Gobierno de coalición de centro`="coalition_center", `Gobierno de coalición de derechas`="coalition_right", `Gobierno monocolor de izquierdas`="singlecolor_left", `Gobierno monocolor de centro`="singlecolor_center", `Gobierno monocolor de derechas`="singlecolor_right", `Repetición de elecciones`="repetition_elections") %>%
gather("type", "prob", c(`Gobierno de coalición de izquierdas`:`Repetición de elecciones`)) %>%
mutate(diff =  prob - lag(prob, default = first(prob))) %>%
filter(datetime == max(datetime)) %>%
mutate_if(is.numeric, round, 2) %>%
select(type, prob, diff) %>%
arrange(desc(prob))
generales_gather <- generales_reduce %>% select(datetime, `Coalición de izquierda`= "coalition_left", `Coalición de centro`="coalition_center", `Coalición de derecha`="coalition_right", `Monocolor de izquierda`="singlecolor_left", `Monocolor de centro`="singlecolor_center", `Monocolor de derecha`="singlecolor_right", `Repetición electoral`="repetition_elections") %>%
gather("type", "prob", c(`Coalición de izquierda`:`Repetición electoral`))
#Set our working directory.
#This helps avoid confusion if our working directory is
#not our site because of other projects we were
#working on at the time.
setwd("/Users/ortega/Desktop/website/predi_latam")
#render your sweet site.
rmarkdown::render_site()
devtools::install_github("hadley/emo")
Sys.setenv(LC_COLLATE = "en_US.UTF-8")
Sys.setenv(LC_CTYPE  = "en_US.UTF-8")
Sys.setenv(LC_MONETARY = "en_US.UTF-8")
Sys.setenv(LC_NUMERIC = "en_US.UTF-8")
Sys.setenv(LC_TIME = "en_US.UTF-8")
Sys.getenv()
devtools::install_github("hadley/emo")
devtools::install_github("ropenscilabs/icon")
devtools::install_github("ropenscilabs/icon", force = TRUE)
